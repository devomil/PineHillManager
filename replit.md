# Pine Hill Farm Employee Management System

## Overview
The Pine Hill Farm Employee Management System is a comprehensive platform designed to streamline operations for employees, managers, and administrators at Pine Hill Farm. Its core purpose is to provide role-based access for time tracking, scheduling, communication, support ticket management, and robust accounting. The system aims to integrate essential business tools to offer an all-in-one solution for farm management, enhancing efficiency and oversight across all departments.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### UI/UX Decisions
The frontend uses React 18 with TypeScript and Vite. Radix UI provides accessible components, styled with Tailwind CSS, ensuring a consistent and branded look using the Great Vibes font. The design emphasizes a clear, multi-role dashboard experience for Admin, Manager, and Employee users with dedicated page access. A modern, responsive sidebar navigation is implemented for admin/manager users, featuring collapsible desktop functionality and a mobile hamburger drawer menu.

### Technical Implementations
- **Frontend**: React 18, TypeScript, Vite, Radix UI, Tailwind CSS, TanStack Query, Wouter.
- **Backend**: Express.js, TypeScript, PostgreSQL with Drizzle ORM, bcrypt, session-based authentication.
- **Database**: PostgreSQL hosted on Neon Database, Drizzle ORM for type-safe operations and migrations.
- **Data Storage**: Replit Object Storage (Google Cloud Storage) for announcement images with presigned URL uploads and ACL policies. Local file system for other document uploads.
- **Communication**: Mobile-first SMS integration via Twilio API, SendGrid for email, WebSocket support for real-time features.
- **Authentication**: Session-based, role-based access control (Admin, Manager, Employee), with employee invitation and password reset.

### Feature Specifications
- **Time Management**: Clock in/out with break tracking, multi-location scheduling, time off requests with role-based privacy protection (employees cannot view other employees' time off reasons; only managers and admins have access to request details), manual time entry capabilities for employees, and comprehensive Scheduled vs Actual Hours reporting for labor variance analysis and payroll expense tracking. PDF schedule generation features vibrant colored shift boxes matching the UI calendar design exactly, with adaptive font sizing, employee first names, dynamic cell height calculation for single-page output (4-6 week months), and full calendar weeks with padding days from previous/next months. All date calculations use UTC methods to prevent timezone-related calendar alignment issues. Employee upcoming shifts view uses local timezone parsing (parseLocalDate helper) to prevent date display discrepancies. **Shift Scheduling Interface**: Modern drag-and-drop scheduling with vertical employee sidebar (256px width, sticky positioning) allowing admins/managers to drag employees directly onto calendar dates for quick shift assignment. **Shift Swap Marketplace**: Comprehensive shift swap system at `/shift-swaps` with SMS notifications and admin controls. When posting a shift swap, users can select up to 10 employees to notify via SMS about the availability, including shift details (date, time, location) and urgency level. Notifications are sent asynchronously to employees who have opted in to SMS via Twilio integration. Admin and manager users have delete capabilities via trash icon button with confirmation dialog for swap request moderation and cleanup.
- **Communication & Support**: Mobile-first SMS-integrated team messaging with interactive responses, TCPA-compliant consent tracking via Twilio, and real-time integration via WebSockets. Admin SMS management interface available in Employee Management > Edit Employee > Settings tab for managing employee SMS consent, notification preferences, and viewing consent history. New employees require manual SMS opt-in via admin interface.
- **Document Management**: Comprehensive document center with dual interfaces for role-based access. **Admin/Manager View** (`/documents`): Full document management interface with AdminLayout sidebar navigation, supporting upload (10MB limit), categorization (policies, forms, training, general), description/notes, public/private permissions, and delete capabilities. Uses existing multer upload middleware storing files locally in uploads directory. **Employee View** (`/employee/documents`): Clean, read-only interface with search functionality, category filtering, document cards grouped by type, download capabilities, and print/preview options. Both views use shared `/api/documents` endpoint with built-in role-based filtering ensuring employees only see authorized documents. Document tracking includes upload logs with user/IP/user-agent information for audit trails. All document operations safely reuse existing storage infrastructure without modifications to ObjectStorageService.
- **Inventory Management**: Dedicated `/inventory` page with comprehensive dual-system tracking reconciling Clover POS (live inventory) and Thrive (vendor/cost data). Features include a unified dashboard showing synced items only (active inventory with positive stock, excluding historical/discontinued products), real-time sync status, profitability analytics with dual pricing systems (Clover cost with Thrive vendor cost fallback when POS cost is missing), manual matching interface for unmatched items, discrepancy resolution workflow, and enhanced CSV import with sync status tracking. Dashboard metrics (Total Items and Inventory Value) reflect only synced, in-stock items representing actual sellable inventory. **Vendor Negotiation Insights**: Comprehensive vendor analytics on Vendors tab with strategic insights for purchasing negotiations including: top vendors by spend with negotiation priority levels (High/Medium/Low based on spend thresholds), low margin opportunities identifying items below 20% margin with potential savings calculations, vendor consolidation opportunities for vendors with few items and low spend, and high-value focus areas showing top 3 items by inventory value per vendor. All vendor analytics use only synced active inventory with intelligent cost fallback logic ensuring accurate calculations.
- **Order Management**: Dedicated `/orders` page for comprehensive order processing with real-time analytics, payment tracking, and performance insights across all store locations. **Performance Optimizations**: Financial metrics endpoint supports optional COGS calculation via `?includeCogs=true` parameter - by default, COGS is disabled for fast page loads (under 5 seconds), but can be enabled on-demand for detailed profit/margin analysis. This optimization reduces initial load time from 67+ seconds to under 5 seconds while preserving data accuracy for revenue metrics.
- **Accounting**: Comprehensive financial management with live integrations for Clover POS, Amazon Store, HSA, and Thrive inventory. Features real-time revenue dashboards, multi-location analytics, accurate COGS calculations, critical discount and refund reporting with exact matching to Clover, and automated Chart of Accounts with standard accounts auto-populated on startup (1300-Inventory, 2100-Sales Tax Payable, 4100-Total Sales Revenue, 5000-COGS, 6700-Payroll Expense). Chart of Accounts automatically syncs daily at 12:01 AM CT with live Clover POS and Amazon sales data, updating each location's sales account balances with net revenue (gross sales minus refunds). Manual sync available via POST /api/accounting/accounts/sync. Includes accurate Profit & Loss statements pulling from standard accounts and live multi-location API data. **QuickBooks Online Integration**: Full OAuth 2.0 integration with secure token management, CSRF protection via state parameter validation, and automatic token refresh. Database config reload on every API call ensures persistence across server restarts. Available at `/integrations` page with "Connect to QuickBooks" button. Syncs Chart of Accounts, Customers/Vendors, and provides real-time connection testing. Production-ready implementation follows security best practices with required state validation preventing OAuth CSRF attacks. **Monthly Business Intelligence**: Enhanced dashboard section showing real-time October 2025 performance metrics including Revenue (from multi-location analytics), COGS (from inventory cost tracking), Payroll (from actual time entries), Total Expenses, Gross Profit, Gross Margin, Daily Average Revenue, and Projected Month-End values with confidence indicators. **COGS Tracking Improvements**: Both daily and historical Clover order syncs now automatically populate item-level cost data by matching line items to inventory using Clover item IDs and extracting standardCost/unitCost from inventory records. The `pos_sale_items.costBasis` field stores per-item costs for accurate COGS aggregation. Backfill endpoint available at POST /api/integrations/clover/backfill-costs to retroactively populate cost data for existing orders that have inventory linkage but missing costBasis values. **Cached Financial Reports System**: Production-ready report caching infrastructure optimized for historical data retrieval with hybrid schema design (structured period metadata + flexible JSON reportData). Implements unique constraint enforcement using "all" sentinel values instead of NULL to prevent duplicate cached reports per period/location scope. Database tables: `cached_financial_reports` (stores pre-computed reports with reportType, periodStart, periodEnd, locationId, merchantId, reportData JSONB, isStale flag, generation tracking) and `report_cache_metadata` (tracks lastGeneratedAt, totalCachedReports, averageGenerationTime per reportType). API endpoints: POST /api/accounting/cached-reports/generate (creates cached report with reportType validation), GET /api/accounting/cached-reports (retrieves with filtering), GET /api/accounting/cached-reports/latest (gets most recent for type/period), DELETE /api/accounting/cached-reports/:id (admin-only deletion). Supported reportTypes: revenue-trends, profit-loss, location-revenue. All date handling uses Drizzle-compatible string format ('YYYY-MM-DD'). System prevents slow historical queries by pre-computing complex financial summaries and storing them for instant retrieval.
- **Video Generation**: A professional video engine built with native Canvas API for creating animated explainer videos.
- **Employee Purchase Portal**: Dedicated `/employee-purchases` page for employees to scan and purchase inventory items using their monthly allowance, with real-time balance tracking and purchase history. Pricing model by role: **Managers/Admins** - before cap: 100% discount (no charge until allowance used); after cap: COGS + markup % for out-of-pocket purchases. **Regular Employees** - before cap: full retail price charged against free monthly allowance; after cap: 25% off retail price for out-of-pocket purchases. **Balance Tracking**: Role-based calculation where managers/admins track COGS value (actual cost to company) while regular employees track retail value (charged against allowance). **Enhanced Shopping Cart**: Visual pricing breakdown showing within-allowance vs over-cap pricing, location selector dropdown (Watertown/Lake Geneva), and notes field for special instructions/approvals (e.g., "Owner approved 3 for price of 1"). Admin reporting available at `/admin/employees/purchases` showing spending, allowances, and after-cap pricing by role across all employees. **Clover Payment Integration**: Secure credit card processing via Clover POS API for over-cap purchases using PCI-compliant iframe tokenization with Ecommerce public/private keys from merchant dashboard. Payment flow includes automatic cart calculation, Clover charge creation with card token, payment status tracking, and refund capabilities. Database tracks Clover payment IDs, card last 4 digits, payment method, location ID, notes, and processing timestamps. **Automatic Inventory Deduction**: After purchase completion, purchased items are automatically deducted from Clover inventory stock counts at the selected location using location-to-merchant mapping with per-request service instances to prevent credential mixing during concurrent purchases.
- **Task Management System**: Comprehensive task management system with role-based access at `/tasks`. Features include task creation with priority and due dates, assignee selection, step-by-step checklists, status tracking with automatic workflow, comments, filtering, and dashboard integration with progress indicators.
- **Training & Learning System**: Comprehensive employee training platform with personalized learning paths, progress tracking, and skill assessment. Features include training modules with lessons, quiz-based assessments, automated skill granting on completion, mandatory training tracking, overdue alerts, role-based module access, progress dashboards, and admin management interface for creating/editing courses at `/admin/training`. AI-powered content generation via Anthropic Claude creates properly formatted HTML lessons with semantic structure including headings, bullet lists, and Q&A pairs. Lessons display with academic formatting and proper spacing. The formatLessonContent() helper in training-module.tsx provides backward compatibility for plain text content but all new AI-generated content uses HTML directly for consistency.

### System Design Choices
The system follows a clear separation of concerns between frontend and backend. Authentication is session-based with robust password hashing. Data flow is designed for clarity, and performance is considered through optimized database queries and consistent timezone handling (CST). The architecture supports multi-merchant configurations and department-specific page access. Key optimizations include real-time API data fetching, efficient React Query caching, and a self-contained component design where components auto-fetch data. All endpoints require proper authentication.

## External Dependencies

-   **Email Service**: SendGrid
-   **Database Hosting**: Neon Database
-   **ORM**: Drizzle
-   **UI Components**: Radix UI
-   **Styling**: Tailwind CSS
-   **Fonts**: Great Vibes
-   **Development Tools**: TypeScript, Vite, React Query
-   **Accounting Integrations**: QuickBooks, Clover POS, Amazon Store API, HSA Providers, Thrive Inventory
-   **Content Generation**: Hugging Face API
-   **SMS Service**: Twilio API