The Real Problem
I misread the PiAPI documentation. The endpoint expects JSON with base64, NOT multipart/form-data!
The original code had the wrong parameter names:

Used file instead of file_data
Used filename instead of file_name

PiAPI Documentation Says:
Content-Type: application/json

Request Body Parameters:
- file_name (string): Name of the file with extension
- file_data (string): Base64 encoded file data
The Fix
Replace the uploadImageToPiAPIStorage function with:
typescript/**
 * Upload image to PiAPI's ephemeral storage.
 * Returns a storage.theapi.app URL (same as PiAPI Workspace uses).
 * Files are automatically deleted after 24 hours.
 * 
 * PiAPI expects JSON with base64, NOT multipart/form-data!
 */
async function uploadImageToPiAPIStorage(
  imageBuffer: Buffer,
  filename: string
): Promise<string | null> {
  const apiKey = process.env.PIAPI_API_KEY;
  
  if (!apiKey) {
    console.log('[PiAPI Upload] No PIAPI_API_KEY configured');
    return null;
  }
  
  try {
    console.log(`[PiAPI Upload] Uploading ${filename} (${imageBuffer.length} bytes)...`);
    
    // Convert buffer to base64
    const base64Data = imageBuffer.toString('base64');
    
    // PiAPI expects JSON with these EXACT parameter names
    const requestBody = {
      file_name: filename,      // NOT "filename"
      file_data: base64Data,    // NOT "file", just base64 without data URI prefix
    };
    
    console.log(`[PiAPI Upload] Sending JSON request with file_name: ${filename}`);
    
    const response = await fetch('https://upload.theapi.app/api/ephemeral_resource', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
      },
      body: JSON.stringify(requestBody),
    });
    
    const responseText = await response.text();
    console.log(`[PiAPI Upload] Response status: ${response.status}`);
    console.log(`[PiAPI Upload] Response body: ${responseText.substring(0, 500)}`);
    
    if (!response.ok) {
      console.error(`[PiAPI Upload] Failed: ${response.status} - ${responseText}`);
      return null;
    }
    
    const data = JSON.parse(responseText);
    
    // Extract URL from response
    const imageUrl = data?.url || data?.data?.url || data?.image_url || data?.file_url;
    
    if (imageUrl) {
      console.log(`[PiAPI Upload] Success! URL: ${imageUrl}`);
      return imageUrl;
    }
    
    console.log('[PiAPI Upload] No URL in response:', responseText);
    return null;
    
  } catch (error: any) {
    console.error('[PiAPI Upload] Error:', error.message);
    return null;
  }
}
Key Differences
Wrong (before)Correct (after)filenamefile_namefilefile_datadata:image/png;base64,${base64}Just ${base64} (no data URI prefix)multipart/form-data attemptsContent-Type: application/json
Expected Success Response
json{
  "code": 200,
  "data": {
    "url": "https://storage.theapi.app/images/xxx.png"
  },
  "message": "success"
}
Test After Fix
Logs should show:
[PiAPI Upload] Uploading brand_asset_123.png (245632 bytes)...
[PiAPI Upload] Sending JSON request with file_name: brand_asset_123.png
[PiAPI Upload] Response status: 200
[PiAPI Upload] Response body: {"code":200,"data":{"url":"https://storage.theapi.app/..."},"message":"success"}
[PiAPI Upload] Success! URL: https://storage.theapi.app/images/...