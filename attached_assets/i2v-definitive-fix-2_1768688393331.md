# DEFINITIVE FIX: I2V Prompt Handling

## Problem Summary

The `sanitizePromptForAI()` function:
1. Replaces "pine hill farm" with "wellness center"
2. Adds a massive suffix: "IMPORTANT: Do not include any text, words, letters, numbers, logos, watermarks, labels..."

**This is CORRECT for T2V** (text-to-video) because AI models render text poorly.

**This is CATASTROPHIC for I2V** (image-to-video) because:
- The source image ALREADY contains text/logos (product label)
- Telling the model "no text/logos" causes it to try to REMOVE existing text
- Changing "pine hill farm" to "wellness center" confuses the model about the image content

## Evidence

### PiAPI Workspace (Perfect Results)
```json
{
  "prompt": "Warm sunlit wellness space with natural wooden surfaces and flowing white linen curtains, soft golden morning light streaming through windows, creating gentle rim lighting around the pine hill farm Black Cohosh supplement on a table."
}
```
**No sanitization. No "no text" suffix. Perfect fidelity.**

### Your App (Poor Fidelity)  
```json
{
  "prompt": "Warm sunlit wellness space with natural wooden surfaces and flowing white linen curtains, soft golden morning light streaming through windows, creating gentle rim lighting around the wellness center Black Cohosh supplement on a table. IMPORTANT: Do not include any text, words, letters, numbers, logos, watermarks, labels, buttons, badges, banners, or UI elements in the image. Generate only the pure visual scene without any overlaid text or graphics."
}
```
**Brand name changed + "no text" instruction = model tries to regenerate/remove product labels**

---

## The Fix

### Option 1: Skip Sanitization for I2V (Recommended)

In `server/services/piapi-video-service.ts`, update `generateImageToVideo()`:

```typescript
async generateImageToVideo(options: {
  imageUrl: string;
  prompt: string;
  duration: number;
  aspectRatio: '16:9' | '9:16' | '1:1';
  model: string;
  negativePrompt?: string;
  i2vSettings?: {
    imageControlStrength?: number;
    animationStyle?: 'product-hero' | 'product-static' | 'subtle-motion' | 'dynamic';
    motionStrength?: number;
  };
}): Promise<PiAPIGenerationResult> {
  if (!this.isAvailable()) {
    return { success: false, error: 'PiAPI key not configured' };
  }

  const startTime = Date.now();
  
  // ============================================================
  // CRITICAL FIX: DO NOT SANITIZE PROMPT FOR I2V
  // ============================================================
  // 
  // For T2V: Sanitization prevents AI from rendering text (good)
  // For I2V: The image ALREADY contains text/logos - we want to PRESERVE them
  //
  // The sanitizer adds "Do not include any text, logos, watermarks..."
  // which causes the model to try to REMOVE existing content from the image!
  //
  // Use ORIGINAL prompt for I2V - the image IS the content.
  // ============================================================
  
  const promptForI2V = options.prompt.trim();
  
  console.log(`[PiAPI:${options.model}] ========== I2V GENERATION ==========`);
  console.log(`[PiAPI:${options.model}] SKIPPING SANITIZATION (I2V preserves source image)`);
  console.log(`[PiAPI:${options.model}] Original prompt used: ${promptForI2V}`);
  console.log(`[PiAPI:${options.model}] Image URL: ${options.imageUrl}`);

  try {
    const requestBody = this.buildI2VRequestBody(options, promptForI2V);
    
    // Log full request for debugging
    console.log(`[PiAPI:${options.model}] === I2V REQUEST BODY ===`);
    console.log(JSON.stringify(requestBody, null, 2));
    console.log(`[PiAPI:${options.model}] ========================`);
    
    // ... rest of method unchanged
```

### Option 2: Create I2V-Specific Light Sanitizer

If you want some cleanup but not the destructive parts:

```typescript
/**
 * Light sanitization for I2V - only removes dangerous patterns
 * Does NOT add "no text" suffix or remove brand names
 */
export function sanitizePromptForI2V(prompt: string): string {
  let clean = prompt.trim();
  
  // Only remove obvious overlay/UI requests (not brand names!)
  const lightPatterns = [
    /(?:add|include|show)\s+(?:a\s+)?(?:text|title)\s+overlay/gi,
    /(?:add|include|show)\s+(?:a\s+)?button/gi,
    /(?:add|include|show)\s+(?:a\s+)?banner/gi,
  ];
  
  for (const pattern of lightPatterns) {
    clean = clean.replace(pattern, '');
  }
  
  // Clean up whitespace
  clean = clean.replace(/\s+/g, ' ').trim();
  
  // DO NOT add "no text" suffix - image already has content
  // DO NOT replace brand names - they're in the image
  
  return clean;
}
```

---

## Changes Required in `piapi-video-service.ts`

### Line ~618 - Replace this:

```typescript
const sanitized = sanitizePromptForAI(options.prompt, 'video');
const sanitizedPrompt = enhancePromptForProvider(sanitized.cleanPrompt, options.model);
```

### With this:

```typescript
// FOR I2V: Use original prompt - DO NOT sanitize
// The image already contains the content (product, labels, branding)
// Sanitization adds "no text/logos" which causes the model to 
// try to remove existing content from the source image!
const promptForI2V = options.prompt.trim();

console.log(`[PiAPI:${options.model}] I2V: Using ORIGINAL prompt (no sanitization)`);
console.log(`[PiAPI:${options.model}] Prompt: ${promptForI2V.substring(0, 100)}...`);
```

---

## Changes Required in `buildI2VRequestBody()` for Veo

### Line ~720 - Update Veo section:

```typescript
if (options.model.includes('veo')) {
  let veoModel = 'veo3';
  let taskType = 'veo3-video';

  if (options.model.includes('veo-3.1') || options.model.includes('veo3.1')) {
    veoModel = 'veo3.1';
    taskType = 'veo3.1-video';
  } else if (options.model.includes('veo-2') || options.model.includes('veo2')) {
    veoModel = 'veo2';
    taskType = 'veo2-video';
  }

  console.log(`[PiAPI I2V] Veo ${veoModel}: Matching PiAPI Workspace parameters`);

  return {
    model: veoModel,
    task_type: taskType,
    input: {
      prompt: sanitizedPrompt,  // This is now the ORIGINAL prompt
      image_url: options.imageUrl,
      aspect_ratio: options.aspectRatio || '16:9',
      duration: `${Math.min(options.duration, 8)}s`,
      resolution: '720p',       // ← CHANGED from 1080p (match workspace)
      generate_audio: true,     // ← CHANGED from false (match workspace)
    },
  };
}
```

---

## Testing Checklist

After implementing:

1. [ ] Generate I2V video with Veo 3.1
2. [ ] Check server logs show: `I2V: Using ORIGINAL prompt (no sanitization)`
3. [ ] Verify prompt in logs matches UI exactly (includes "pine hill farm")
4. [ ] Verify no "IMPORTANT: Do not include any text..." in logged prompt
5. [ ] Compare output video to PiAPI Workspace - should match

---

## Why This Works

| Scenario | What Happens |
|----------|--------------|
| **T2V (text-to-video)** | No source image. Sanitization prevents AI from rendering text poorly. ✅ |
| **I2V (image-to-video)** | Source image HAS text/logos. Prompt describes animation, not content. ✅ |

For I2V, the prompt should describe:
- The **environment** (lighting, mood, atmosphere)
- The **motion** (camera movement, animation style)

NOT:
- What text should appear (it's already in the image)
- What NOT to include (the image defines the content)

---

## Summary

**Root Cause:** `sanitizePromptForAI()` adds "Do not include any text, logos..." which causes I2V models to try to remove existing content from the source image.

**Fix:** Skip sanitization for I2V. Use original prompt.

**Verification:** Compare logged request body to PiAPI Workspace task details - they should match exactly.
